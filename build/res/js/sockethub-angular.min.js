/*! built for dogfeed 2013-06-23 */
angular.module("ngSockethubClient",[]).value("settings",{sockethub:function(){var a={host:"localhost",port:"10550",path:"/sockethub",tls:!1,secret:"1234567890"};return a}}).factory("SH",["$rootScope","$q","$timeout","settings",function(a,b,c,d){function e(){return f(p)}function f(a){return a||(a=p),a.host&&""!==a.host&&a.port&&""!==a.port&&a.path&&""!==a.path&&"boolean"==typeof a.tls&&a.secret&&""!==a.secret?!0:!1}function g(a){var c=b.defer();return console.log("SH.setConfig: received "+a.host+", "+a.port+", "+a.path+", TLS:"+a.tls+", SECRET:"+a.secret),f(a)?(p=a,c.resolve()):c.reject("some config properties missing"),c.promise}function h(){return o?o.isConnected():!1}function i(){return o?o.isRegistered():!1}function j(d){var e=b.defer(),f=500;return function g(){d.testFunc()?(console.log("SH: calling: "+d.callFunc),o[d.callFunc].apply(o,d.callParams).then(function(b){a.$apply(e.resolve(b))},function(b){a.$apply(e.reject(b))})):(console.log("SH: delaying call 1s"),3e4>f&&(f+=2*f),c(g,f))}(),e.promise}function k(){var c=b.defer(),d="ws://";return p.tls&&(d="wss://"),SockethubClient.connect({host:d+p.host+":"+p.port+p.path,confirmationTimeout:3e3}).then(function(b){o=b,console.log("CONNECTED [connected: "+o.isConnected()+"] [registered: "+o.isRegistered()+"]"),o.on("message",function(b){b.platform&&q.message[b.platform]&&(console.log("SH passing message to platform: "+b.platform),a.$apply(q.message[b.platform](b)))}),o.on("error",function(b){console.log("SH received error: ",b),b.platform&&q.error[b.platform]&&(console.log("SH passing error to platform: "+b.platform),a.$apply(q.error[b.platform](b)))}),o.on("response",function(b){console.log("SH received response: ",b),b.platform&&q.response[b.platform]&&(console.log("SH passing response to platform: "+b.platform),a.$apply(q.response[b.platform](b)))}),o.on("close",function(b){console.log("SH received close: ",b),b&&b.platform&&q[close][b.platform]&&(console.log("SH passing close to platform: "+b.platform),a.$apply(q.close[b.platform](b)))}),a.$apply(function(){c.resolve()})},function(b){a.$apply(function(){c.reject(b)})}),c.promise}function l(){var a=b.defer();return console.log("SH.register() called"),j({testFunc:h,callFunc:"register",callParams:[{secret:p.secret}]}).then(a.resolve,a.reject),a.promise}function m(a,c,d,e){var f=b.defer(),g={};return g[c]={},g[c][d]=e,j({testFunc:i,callFunc:"set",callParams:[a,g]}).then(f.resolve,f.reject),f.promise}function n(a,c){var d=b.defer();return j({testFunc:i,callFunc:"submit",callParams:[a,c]}).then(d.resolve,d.reject),d.promise}var o,p=d,q={error:{},message:{},response:{},close:{}},r=function(a,b,c){q[b][a]=c};return{config:p,existsConfig:e,setConfig:g,connect:k,register:l,isConnected:h,isRegistered:i,set:m,submit:n,on:r}}]);