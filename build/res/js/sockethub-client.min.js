/*! built for dogfeed 2013-06-23 */
!function(a){function b(){}function c(a,b,c,d){function e(a,b,c){if("object"!=typeof i[a])throw"finishCommand() - unable to find command object for rid "+a;cmd=i[a],delete i[a];var d=cmd.promise;delete cmd.promise,b?d.fulfill():d.reject(c)}function f(a,b,c){if("object"!=typeof i[a])throw"finishCommand() - unable to find command object for rid "+a;b?i[a].confirmed=(new Date).getTime():e(a.result,c)}function g(a){if("object"!=typeof i[a.rid])throw"respondCommand() - unable to find command object for rid "+a.rid;var b=(new Date).getTime();i[a.rid].response=b;var c=i[a.rid];"object"==typeof c.promise?"undefined"!=typeof a.status&&a.status===!1?(c.log(3,"rejecting promise"),c.confirmed||(c.confirmed=b),c.promise.reject(a)):("register"===a.verb&&(j.state.isRegistered=!0,c.log(4,"register object: "+JSON.stringify(a))),c.log(2,"fulfilling promise"),c.promise.fulfill(a)):(c.log(2,"issuing 'response' callback"),j.callbacks.response(a))}function h(a){this.sent=null,this.confirmed=null,this.confirmTimeout=j.cfg.confirmationTimeout,this.response=null,this.responseTimeout=5e3,this.promise=promising(),this.sendObject={rid:++j.counter,platform:a.platform,verb:a.verb},this.sendObject.actor=a.actor,this.sendObject.target=a.target,this.sendObject.object=a.object}this.sock=a,this.cfg={host:b,enablePings:c,confirmationTimeout:d},this.state={isRegistered:!1,isConnected:!0,pausePing:!0},this.counter=0,this.callbacks={message:function(){},response:function(){},error:function(){},close:function(){}};var i={};this.assertConnected=function(){if("undefined"==typeof a)throw new Error("You need to connect sockethub before sending anything!")},this.lookupVerb=function(a){return"undefined"!=typeof i[a]?i[a].sendObject.verb:""},this.log=function(a,b,c){var d="";b&&(d=":"+this.lookupVerb(b)),1===a?console.log("  [sockethub"+d+"] info    - "+c):2===a?console.log("  [sockethub"+d+"] success - "+c):3===a?console.log("  [sockethub"+d+"] error   - "+c):4===a&&console.log("  [sockethub"+d+"] debug   - "+c)};var j=this;a.onopen=function(){j.log(4,null,"onopen fired"),j.state.isConnected=!0},a.onclose=function(){j.log(4,null,"onclose fired"),j.state.pausePing=!0,j.state.isConnected=!1,j.state.isRegistered=!1,j.callbacks.close()},a.onmessage=function(a){console.log(" "),j.log(4,null,"onmessage fired ",a.data);var b=JSON.parse(a.data);if((new Date).getTime(),"confirm"===b.verb)j.log(4,b.rid,"confirmation receipt received. for rid "+b.rid),f(b.rid,!0);else{if("undefined"==typeof b.rid)return j.callbacks.message(b),void 0;g(b)}},h.prototype={constructor:h,getRID:function(){return this.sendObject.rid},log:function(a,b){j.log(a,this.getRID(),b)},send:function(){function b(){d.sent=(new Date).getTime(),a.send(c),setTimeout(function(){d.log(4,"checking confirmation status for rid:"+d.getRID()),d.confirmed?(d.log(2,"confirmation received"),d.log(4,"setting responseTimeout "+d.responseTimeout+"ms"),setTimeout(function(){d.response?d.log(2,"response received"):(d.log(3,"response not received, rejecting promise"),e(d.getRID(),!1,"response timed out"))},d.responseTimeout)):(d.log(3,"confirmation not received after "+d.confirmTimeout+"ms, sending again."),b())},d.confirmTimeout)}var c=JSON.stringify(this.sendObject),d=this;return b(),this.promise}},this.createCommand=function(a){var b=new h(a);return i[b.getRID()]=b,b}}c.prototype.on=function(a,b){"undefined"!=typeof this.callbacks[a]&&"function"==typeof b?this.callbacks[a]=b:console.log("  [sockethub] ERROR: invalid callback function or type name: "+a)},c.prototype.reconnect=function(){this.state.pausePing=!0,this.state.isConnected=!1,this.state.isRegistered=!1,setTimeout(function(){this.sock.close(),setTimeout(function(){this.connect(cfg)},0)},0)},c.prototype.isConnected=function(){return this.state.isConnected},c.prototype.isRegistered=function(){return this.state.isRegistered},c.prototype.togglePings=function(){return this.state.pausePing=this.state.pausePing?!1:!0,this.state.pausePing},c.prototype.register=function(a){this.log(4,null,"sockethub.register called"),this.assertConnected();var b=this.createCommand({platform:"dispatcher",verb:"register",object:a});return b.send()},c.prototype.set=function(a,b){this.assertConnected();var c=this.createCommand({platform:"dispatcher",verb:"set",target:{platform:a},object:b});return c.send()},c.prototype.submit=function(a,b){if(this.assertConnected(),"undefined"==typeof a.verb)throw this.log(3,null,"verb must be specified in object"),"verb must be specified in object";var c=this.createCommand(a);return b&&(c.responseTimeout=b),c.send()},b.prototype.connect=function(a){var b=promising(),d=!0;if("object"!=typeof a)return b.reject("connection object not received"),b;if("undefined"==typeof a.host)return console.log("  [SockethubClient] sockethub.connect requires an object parameter with a 'host' property",a),b.reject("sockethub.connect requires an object parameter with a 'host' property"),b;"undefined"!=typeof a.confirmationTimeout&&(a.confirmationTimeout=4e3),"undefined"!=typeof a.enablePings&&(a.enablePings=!0),console.log("  [SockethubClient] attempting to connect to "+a.host);try{sock=new WebSocket(a.host,"sockethub")}catch(e){console.log("  [SockethubClient] error connecting to sockethub: "+e),b.reject("error connecting to sockethub: "+e)}return sock?(sock.onopen=function(){if(console.log("  [SockethubClient] onopen fired"),d){d=!1;var e=new c(sock,a.host,a.enablePings,a.confirmationTimeout);b.fulfill(e)}},sock.onclose=function(){console.log("  [SockethubClient] onclose fired"),d&&(d=!1,b.reject("Unable to connect to sockethub at "+a.host))},b):b},a.SockethubClient=new b}(window,document),function(){function a(b){function c(a){if(f){var b;if(a.fulfilled)try{b=[a.fulfilled.apply(null,g)]}catch(c){return a.promise.reject(c),void 0}else b=g;b[0]&&"function"==typeof b[0].then?b[0].then(a.promise.fulfill,a.promise.reject):a.promise.fulfill.apply(null,b)}else if(a.rejected){var d;try{d=a.rejected.apply(null,g)}catch(c){return a.promise.reject(c),void 0}d&&"function"==typeof d.then?d.then(a.promise.fulfill,a.promise.reject):a.promise.fulfill(d)}else a.promise.reject.apply(null,g)}function d(a,b){return g?(console.log("WARNING: Can't resolve promise, already resolved!"),void 0):(f=a,g=Array.prototype.slice.call(b),setTimeout(function(){for(var a=h.length,b=0;a>b;b++)c(h[b]);h=void 0},0),void 0)}var e;"function"==typeof b&&setTimeout(function(){try{b(e)}catch(a){e.reject(a)}},0);var f,g,h=[];return e={then:function(b,d){var e={fulfilled:"function"==typeof b?b:void 0,rejected:"function"==typeof d?d:void 0,promise:a()};return g?setTimeout(function(){c(e)},0):h.push(e),e.promise},fulfill:function(){return d(!0,arguments),this},reject:function(){return d(!1,arguments),this}}}"undefined"!=typeof module?module.exports=a:"function"==typeof define?define([],function(){return a}):"undefined"!=typeof window&&(window.promising=a)}();