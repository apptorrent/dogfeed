/*! built for dogfeed 2013-06-23 */
angular.module("dogfeed",["ngRSS","ngSockethubClient"]).value("settings",{sockethub:function(){var a={host:"localhost",port:"10550",path:"/sockethub",tls:!1,secret:"1234567890"};return a}}).config(["$routeProvider",function(a){a.when("/",{templateUrl:"feeds.html"}).otherwise({redirectTo:"/"})}]).run(["settings","SH","$rootScope",function(a,b,c){var d=a.sockethub();b.setConfig(d).then(function(){return b.connect()}).then(function(){return b.register()}).then(function(){console.log("connected to sockethub")},function(a){console.log("error connection to sockethub: ",a),c.$broadcast("SockethubConnectFailed",{message:a})})}]).run(["$rootScope",function(a){a.$on("showModalAddFeed",function(a,b){backdrop_setting=!0,"object"==typeof b&&"undefined"!=typeof b.locked&&b.locked&&(backdrop_setting="static"),$("#modalAddFeed").modal({show:!0,keyboard:!0,backdrop:backdrop_setting})}),a.$on("closeModalAddFeed",function(){$("#modalAddFeed").modal("hide")})}]).filter("urlEncode",[function(){return function(a){return encodeURIComponent(escape(a))}}]).controller("titlebarCtrl",["$scope","$rootScope",function(a,b){a.addFeed=function(){b.$broadcast("showModalAddFeed",{locked:!1})}}]).directive("message",["$rootScope","$timeout",function(a,b){return{restrict:"A",template:'<div class="alert alert-{{ m.type }}" ng-show="haveMessage">  <strong>{{m.title}}</strong>   <span>{{m.message}}</span></div>',link:function(c){c.haveMessage=!1,c.m={type:"",title:"",message:""};var d={"remotestorage-connect":{type:"error",title:"Connect to remoteStorage",message:"First things first. You must connect to your remoteStorage"},"sockethub-config":{type:"error",title:"Sockethub configuration needed",message:"You must fill in your Sockethub connection details"},"sockethub-connect":{type:"error",title:"Sockethub connection error",message:"Unable to connect to Sockethub please check your configuration and try again"},"sockethub-register":{type:"error",title:"Sockethub registration problem",message:"We were unable to register with your Sockethub instance"},"xmpp-connect":{type:"error",title:"XMPP connection failed",message:"There was a problem connecting to the XMPP server, please verify you settings"},unknown:{type:"error",title:"An unknown error has occurred",message:""}};a.$on("message",function(a,e){console.log("message event: ",e);var f="boolean"==typeof e.timeout?e.timeout:!0;c.haveMessage=!1,"undefined"==typeof e&&(e="no error specified"),"undefined"!=typeof d[e.message]?c.m=d[e.message]:"string"==typeof e.message&&(c.m.title="success"===e.type?"Success":"Error",c.m.message=e.message,c.m.type=e.type),console.log("done processing: ",c.m),c.haveMessage=!0,f&&b(function(){c.haveMessage=!1,c.m={type:"",title:"",message:""}},4e3)})}}}]),angular.module("ngRSS",["ngRemoteStorage","ngSockethubClient"]).value("configHelper",{exists:function(a,b){b||(b=a);for(var c in a)if(!b[c])return!1;return!0},set:function(a,b){for(var c in b)a[c]=b[c];return a}}).value("util",{isEmptyObject:function(a){for(var b in a)if(Object.prototype.hasOwnProperty.call(a,b))return!1;return!0}}).factory("RSS",["$q","SH","configHelper","RS","RSutil","$rootScope",function(a,b,c,d,e,f){function g(a){return c.exists(h,a)}var h={},i={articles:[],info:{}},j={};return j.setConfig=function(b){var d=a.defer();return g(b)?(b&&c.set(h,b),d.resolve(h)):d.reject("config not set correctly"),d.promise},function(){d.call("rss","getAll",[""]).then(function(a){for(var b in a){var c=a[b].url;i.info[c]=a[b],j.fetchFeed(c)}},function(a){console.log("error: unable to get feed list from remoteStorage: ",a)})}(),j.addFeed=function(b){var c=a.defer();return d.call("rss","add",[b]).then(function(a){console.log("feed added: ",b),i.info[b.url]=b,j.fetchFeed(b.url),c.resolve(a)},function(a){c.reject(a)}),c.promise},j.updateArticle=function(b){var c=a.defer(),e={link:b.object.link,title:b.object.title,date:b.object.data,html:b.object.html,text:b.object.text,brief_html:b.object.brief_html,brief_text:b.object.brief_text,read:b.object.read?!0:!1,source_link:b.actor.address,source_title:b.actor.name};return d.call("articles","update",[e]).then(function(a){c.resolve(a)},function(a){c.reject(a)}),c.promise},j.fetchFeed=function(c){var d=a.defer(),e={actor:{},target:[{}]};return e.target[0].address=c,e.platform="rss",e.verb="fetch",e.actor.address="rss",console.log("FETCH: ",e),b.submit(e,5e3).then(d.resolve,d.reject),d.promise},b.on("rss","message",function(a){var b=a.actor.address;if(a.status||f.$broadcast("message",{type:"error",message:a.target[0].address+" "+a.object.message}),i.info[b])i.info[b].name!==a.actor.name?(i.info[b].name=a.actor.name,j.addFeed(i.info[b]),i.info[b].loaded=!0):i.info[b].loaded=!0;else if(console.log("*** RSS: key doesn't match a feed entry [ "+b+" ]: ",a),!a.status){var c=a.target[0].address;i.info[c]&&(console.log("PROBLEM FEED SETTINGS:",i.info[c]),i.info[c].loaded=!0,i.info[c].error=!0,i.info[c].errorMsg=a.object.message)}if(a.object.read||(a.object.read=!1),a.status){console.log("adding: ",a);var g=e.encode(a.object.link);console.log("ID: ",g),d.call("articles","get",[g]).then(function(c){c&&(console.log("ARTICLE FETCH from RS: ",c),a.object.read=c.read),a.object.read||(i.info[b].unread="number"==typeof i.info[b].unread?i.info[b].unread+1:1),i.articles.push(a)},function(b){console.log("ARTICL FETCH ERROR: ",b),i.articles.push(a)})}}),{config:h,data:i,func:j}}]).controller("addFeedCtrl",["$scope","RSS","$rootScope",function(a,b,c){a.url="",a.adding=!1,a.add=function(d){a.adding=!0;var e={url:d,name:d,cache_articles:20,last_fetched:(new Date).getTime()};b.func.addFeed(e).then(function(b){console.log("rss feed url saved!: ",b),c.$broadcast("closeModalAddFeed"),a.adding=!1,c.$broadcast("message",{type:"success",message:"RSS feed added: "+e.url})},function(a){console.log("rss feed url save failed!: ",a),c.$broadcast("message",{type:"error",message:a.message})})}}]).controller("feedCtrl",["$scope","RSS","util","$rootScope",function(a,b,c,d){a.model={},a.model.feeds=b.data,a.model.message="",a.model.loading=!0,a.model.feeds.current={name:"",indexes:[]},a.isSelected=function(b,c){if(0===a.model.feeds.current.indexes.length)return c||!b?!0:!1;for(var d=0,e=a.model.feeds.current.indexes.length;e>d;d+=1)if(a.model.feeds.current.indexes[d]===b)return!0;return!1},a.switchFeed=function(c){c?(a.model.feeds.current.name=b.data.info[c].name,a.model.feeds.current.indexes=[c]):(a.model.feeds.current.name="",a.model.feeds.current.indexes=[])},a.showFeedSettings=function(){d.$broadcast("showModalFeedSettings",{locked:!1})},a.markRead=function(c){console.log("markRead Called!");for(var d=0,e=a.model.feeds.articles.length;e>d;d+=1)if(a.model.feeds.articles[d].object.link===c)return a.model.feeds.articles[d].object.read||(a.model.feeds.info[a.model.feeds.articles[d].actor.address].unread=a.model.feeds.info[a.model.feeds.articles[d].actor.address].unread-1,a.model.feeds.articles[d].object.read=!0,b.func.updateArticle(a.model.feeds.articles[d])),void 0},c.isEmptyObject(a.model.feeds.info)&&(a.model.message="loading feed list..."),a.$watch("$scope.model.feeds.info",function(){a.model.message=c.isEmptyObject(a.model.feeds.info)?"no feeds yet, add some!":""}),a.$watch("$scope.model.feeds.articles",function(a,b){console.log("article changed! ",a,b)}),d.$on("SockethubConnectFailed",function(b,c){d.$broadcast("message",{message:c.message,type:"error",timeout:!1}),a.model.loading=!0})}]).directive("feedList",[function(){return{restrict:"E",scope:{feeds:"="},template:'<h4 ng-transclude></h4><span>{{ message }}<span><ul class="nav nav-list" ng-controller="feedCtrl">  <li ng-click="switchFeed()"       ng-class="{active: isSelected(), \'all-feeds\': true}">    <a href="" >      <i class="icon-globe"></i><span>All Items</span>    </a>  </li>  <li ng-repeat="f in feeds.info"      data-toggle="tooltip"       title="{{ f.url }}">    <i ng-click="showFeedSettings(f.url)"      ng-class="{status: true, \'icon-loading-small\': !f.loaded, \'icon-cog\': f.loaded}">    </i>    <div ng-click="switchFeed(f.url)"         ng-class="{active: isSelected(f.url), error: f.error, loading: !f.loaded, \'feed-entry\': true}">      <a href="" ng-class="{error: f.error}">        <span>{{ f.name }}</span> <span class="unread-count">{{ f.unread }}</span>      </a>    </div>  </li></ul>',transclude:!0}}]).directive("articles",[function(){return{restrict:"E",scope:{feeds:"="},template:'<h4>{{ feeds.current.name }}</h4><div ng-repeat="a in feeds.articles | orderBy:a.object.date"     ng-controller="feedCtrl"     ng-click="markRead(a.object.link)"     ng-class="{well: true, hide: !isSelected(a.actor.address, true), unread: !a.object.read, article: true}" >  <h2>{{ a.object.title }}</h2>  <p>feed: <i>{{ a.actor.name }}</i></p>  <p>date: <i>{{ a.object.date | date }}</i></p>  <p>article link: <i><a target="_blank" href="{{ a.object.link }}">{{ a.object.link }}</a><i></p>  <div class="article-body" data-ng-bind-html-unsafe="a.object.brief_html"></div></div>',link:function(a,b,c){console.log("#### LINK FUNCTION: scope: ",a),console.log("#### LINK FUNCTION: element: ",b),console.log("#### LINK FUNCTION: attrs: ",c),a.$watch(c.feeds,function(a){console.log("WATCH - val:",a)});for(var d=document.getElementsByClassName("article"),e=0,f=d.length;f>e;e+=1)for(var g=d[e].getElementsByTagName("a"),h=0,i=g.length;i>h;h+=1)g[h].setAttribute("target","_blank")}}}]);